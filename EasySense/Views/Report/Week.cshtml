
@{
    ViewBag.Title = "周报";
}

<style>
    .table th, .table td {
        color: #333;
    }

    .table td {
        border-bottom: 1px solid #ccc;
    }

    .table tbody tr:hover {
        background-color: #ddd;
    }
</style>

<div class="es-block-menu">
    <a href="/Report/Day/@ViewBag.ID">日报</a>
    <a href="/Report/Week/@ViewBag.ID" class="es-block-menu-active">周报</a>
    <a href="/Report/Month/@ViewBag.ID">月报</a>
    <a href="/Report/New/@ViewBag.ID">填写报告</a>
</div>
<div class="es-block">
    <p>
        年份：
        <select id="lstYears" class="select">
            @for (var i = 1970; i < DateTime.Now.Year; i++)
            {
                <option value="@i">@i</option>
            }
            <option value="@DateTime.Now.Year" selected>@DateTime.Now.Year</option>
        </select>
        周数：
        <select id="lstWeeks" class="select" style="width:280px">

        </select>
        <input type="button" value="检索" id="btnSearchReports" class="button button-def" />
    </p>

    <table class="table">
        <thead>
            <tr>
                <th>日期</th>
                <th>周数</th>
                <th style="width:50%">内容</th>
                <th>记录时间</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody id="lstReports">
        </tbody>
    </table>
</div>

<script>
    $(document).ready(function () {
        function BuildWeekList()
        {
            $("#lstWeeks").html('')
            var year = $("#lstYears").val();
            var thisweek = @ViewBag.ThisWeek;
            for (var i = 1; i <= 53; i++) {
                if(i != thisweek)
                    $("#lstWeeks").append("<option value='" + i + "'>第" + i + "周 (" + mm(year, i) + " 至 " + mml(year, i) + ")</option>");
                else
                    $("#lstWeeks").append("<option selected value='" + i + "'>第" + i + "周 (" + mm(year, i) + " 至 " + mml(year, i) + ")</option>");
            }
        }

        BuildWeekList();

        function LoadReports() {
            ShowLoading();
            $("#lstReports").html('');
            var y = $("#lstYears").val();
            var w = $("#lstWeeks").val();
            $.getJSON("/Report/GetReports/@ViewBag.ID",
                {
                    Type: "Week",
                    year: y,
                    week: w
                }, function (data) {
                    var j = 0;
                    var begin =$("#lstWeeks").val()-2;
                    if(begin < 1)begin = 1;
                    var end = begin+4;
                    if(end > 53)end=53;
                    for (var i = begin; i <= end; i++) {
                        console.log(i+" "+$("#lstWeeks").val());
                        if(i<1)i=1;
                        if(i>53)break;
                        if (j >= data.length || i != data[j].Day) {
                            $("#lstReports").append("<tr><td>" + mm(y, i) + " 至 " + mml(y, i) + "</td><td>" + i + "</td><td></td><td></td><td></td></tr>");
                        }
                        else {
                            $("#lstReports").append("<tr><td>" + mm(y, i) + " 至 " + mml(y, i) + "</td><td>" + i + "</td><td><p><a href='javascript:$(\"#todo-" + data[j].ID + "\").toggle()'>待办事项</a></p><div id='todo-" + data[j].ID + "' class='es-report'>" + data[j].TodoList + "</div><p><a href='javascript:$(\"#question-" + data[j].ID + "\").toggle()'>遇到问题</a></p><div id='question-" + data[j].ID + "' class='es-report'>" + data[j].QuestionList + "</div><p><a href='javascript:$(\"#finished-" + data[j].ID + "\").toggle()'>已办事项</a></p><div id='finished-" + data[j].ID + "' class='es-report'>" + data[j].FinishedList + "</div></td><td>" + data[j].Time + "</td><td><a href='/Report/Edit/" + data[j].ID + "'>编辑</a></td></tr>");
                            j++;
                        }
                    }
                    HideLoading();
                });
        }

        $("#lstYears").change(function () {
            BuildWeekList();
        });

        $("#btnSearchReports").click(function(){
            LoadReports();
        });

        LoadReports();
    });
</script>